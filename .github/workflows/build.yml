name: ğŸ—ï¸ Build OpenWrt Base Source

# è§¦å‘æ¡ä»¶ï¼špush, pull_request, å®šæ—¶ï¼ˆæ¯å¤©ï¼‰å’Œæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
on:
  push:
  #  branches:
  #    - main # åªæœ‰åœ¨ main åˆ†æ”¯ push æ—¶è§¦å‘
  #pull_request: # PR æ—¶è§¦å‘
  #schedule:
  #  - cron: '0 0 * * *'  # æ¯å¤©è‡ªåŠ¨è§¦å‘ä¸€æ¬¡
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    # ä½¿ç”¨è‡ªå®šä¹‰ Docker é•œåƒ
    container:
      image: 298977887/openwrt-builder:latest

    steps:
      - name: ğŸ”¢ ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          VERSION_TAG="v$(date +'%Y%m%d-%H%M')"
          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
      
      - name: ğŸ“¥ å…‹éš† LEDE æºç 
        run: |
          git clone https://github.com/coolsnowwolf/lede
          cd lede

      - name: ğŸ”„ æ›´æ–° feeds å¹¶å®‰è£…
        run: |
          cd lede
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ”§ è®¾ç½®ç¼–è¯‘é…ç½®
        run: |
          cd lede
          # make menuconfig  # è¿™é‡Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®--
          make defconfig  # ç”Ÿæˆé»˜è®¤çš„ .config æ–‡ä»¶

      - name: ğŸ“¦ ä¸‹è½½ dl åº“
        run: |
          cd lede
          make download -j8

      - name: âš™ï¸ ç¼–è¯‘å›ºä»¶
        run: |
          cd lede
          make V=s -j$(nproc) #ä½¿ç”¨æ‰€æœ‰ CPU ç¼–è¯‘

      - name: åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          #tag_name: "v1.0.0"  # æ ¹æ®å®é™…æƒ…å†µè®¾ç½®ç‰ˆæœ¬
          tag_name: "${{ env.VERSION_TAG }}"  # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬å·
          #release_name: "OpenWrt Firmware Release"
          release_name: "OpenWrt Firmware Release ${{ env.VERSION_TAG }}"
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  .vmdk æ–‡ä»¶åˆ° GitHub Releases
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: lede/bin/targets/*/*/*.vmdk  # åŒ¹é…æ‰€æœ‰ .vmdk æ–‡ä»¶
          asset_name: "openwrt_firmware_${{ env.VERSION_TAG }}.vmdk"  # ä½¿ç”¨ç‰ˆæœ¬å·å‘½åæ–‡ä»¶
          asset_content_type: application/octet-stream