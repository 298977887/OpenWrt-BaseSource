name: ğŸ—ï¸ Build OpenWrt Base Source

# è§¦å‘æ¡ä»¶ï¼špush, pull_request, å®šæ—¶ï¼ˆæ¯å¤©ï¼‰å’Œæ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
on:
  push:
  #  branches:
  #    - main # åªæœ‰åœ¨ main åˆ†æ”¯ push æ—¶è§¦å‘
  #pull_request: # PR æ—¶è§¦å‘
  #schedule:
  #  - cron: '0 0 * * *'  # æ¯å¤©è‡ªåŠ¨è§¦å‘ä¸€æ¬¡
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    # ä½¿ç”¨è‡ªå®šä¹‰ Docker é•œåƒ
    #container:
    #  image: 298977887/openwrt-builder:latest

    steps:
      - name: ğŸ›’ æ£€å‡ºä»£ç  - è·å–æœ€æ–°çš„ä»£ç åº“çŠ¶æ€
        uses: actions/checkout@v3
      - name: ğŸ”¢ ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          VERSION_TAG="v$(date +'%Y%m%d-%H%M')"
          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
      
      - name: Init Env
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"

          sudo apt update
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf npm python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          
          # sudo apt install --reinstall libc6
          sudo systemctl daemon-reload
          sudo apt -y autoremove --purge
          sudo apt -y clean

          git clone --depth=1 https://github.com/openwrt-dev/po2lmo
          pushd po2lmo
          make && sudo make install
          popd

          df -h

      - name: ğŸ“¥ å…‹éš† LEDE æºç 
        run: |
          git clone https://github.com/coolsnowwolf/lede
          #cd lede

      #æ·»åŠ æº
      - name: ğŸ“¦ æ·»åŠ æº
        run: |
          cd lede
          echo "å½“å‰ç›®å½•ï¼š" && pwd
          echo "å½“å‰ç”¨æˆ·ä¸ºï¼š" && whoami
          echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
          #echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
          #echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default

      - name: ğŸ”„ æ›´æ–° feeds
        run: |
          cd lede
          ./scripts/feeds update -a

      - name: ğŸ”„ å®‰è£… feeds
        run: |
          cd lede
          ./scripts/feeds install -a

      - name: ğŸ“‘ æ‹·è´.configæ–‡ä»¶ - ç¡®è®¤é…ç½®æ–‡ä»¶çŠ¶æ€
        run: |
          echo "ğŸ“‚å½“å‰ç›®å½•ï¼š" && pwd
          ls -la  #laè¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬éšè—æ–‡ä»¶
          # é‡å‘½åå½“å‰ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶å¹¶æ‹·è´åˆ° lede ç›®å½•ä¸‹
          cp "lede;RUI;x86_64.config" lede/.config    

      - name: ğŸ”§ è®¾ç½®ç¼–è¯‘é…ç½®
        run: |
          cd lede
          # make menuconfig  # è¿™é‡Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®--
          make defconfig  # ç”Ÿæˆé»˜è®¤çš„ .config æ–‡ä»¶

      - name: ğŸ“¦ ä¸‹è½½ dl åº“
        run: |
          cd lede
          make download -j8
          #å»¶è¿Ÿ 10 ç§’ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆ
          sleep 10
          make download -j8
          #å»¶è¿Ÿ 10 ç§’ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆ
          sleep 10
           make download -j8
          #å»¶è¿Ÿ 10 ç§’ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆ
          sleep 10

      - name: âš™ï¸ ç¼–è¯‘å›ºä»¶
        run: |
          cd lede
          make V=s -j$(nproc) #ä½¿ç”¨æ‰€æœ‰ CPU ç¼–è¯‘

      - name: ğŸš€ åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          #tag_name: "v1.0.0"  # æ ¹æ®å®é™…æƒ…å†µè®¾ç½®ç‰ˆæœ¬
          tag_name: "${{ env.VERSION_TAG }}"  # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬å·
          #release_name: "OpenWrt Firmware Release"
          release_name: "OpenWrt Firmware Release ${{ env.VERSION_TAG }}"
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  .vmdk æ–‡ä»¶åˆ° GitHub Releases
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: lede/bin/targets/*/*/*.vmdk  # åŒ¹é…æ‰€æœ‰ .vmdk æ–‡ä»¶
          asset_name: "openwrt_firmware_${{ env.VERSION_TAG }}.vmdk"  # ä½¿ç”¨ç‰ˆæœ¬å·å‘½åæ–‡ä»¶
          asset_content_type: application/octet-stream